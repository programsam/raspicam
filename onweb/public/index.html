<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dropcam</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="/js/jquery-dateFormat.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script>
	      function refreshList() {
		   $.get( "/list", function( data ) {
			   toAdd = "<a href='javascript:clear()'>Clear</a>"
			   toAdd += "<div class='row'>"
			   var i = 0;
			  for (var j=0;j<data.length;j++)
			  {
				  var longDateFormat  = 'dd/MM/yyyy HH:mm:ss';
				  var displayDate = $.format.date(data[j].name, longDateFormat)
				  toAdd += "<div class='col-md-2'>"
				  toAdd += "<a target='_blank' href='" + data[j].url +"'>"
				  toAdd += "<img border=0 width='200px' src='" + data[j].url + "' /></a>"
				  toAdd += "<br />" + displayDate + "[ <a href=\"javascript:delPic('" + data[j].key + "\')\">X</a> ]"
				  toAdd += "</div>"
				  i++;
				  if (i==6)
				  {
					  toAdd += "</row><row>"
					  i = 0;
				  }
			  }
				
				$("#panels").html(toAdd)
			});
	   	}
	      
	      function clear() {
	    	  $.get( "/clear", function( data ) {
	    		refreshList()  
	    	  })
	      }
	      
	      function delPic(passedKey) {
	    	  $.ajax({
	    		  method: "POST",
	    		  url: "/delete",
	    		  data: { "key": passedKey }
	    	  }). done(function (msg) {
	    		  console.log("Data sent, reply: " + JSON.stringify(msg))
	    		  refreshList()
	    	  })
	      }
	   
	   refreshList();
	   
	   
	    function isItDark(imageSrc,callback) {
	        var fuzzy = 0.1;
	        var img = document.createElement("img");
	        img.src = imageSrc;
	        img.style.display = "none";
	        document.body.appendChild(img);

	        img.onload = function() {
	            // create canvas
	            var canvas = document.createElement("canvas");
	            canvas.width = this.width;
	            canvas.height = this.height;

	            var ctx = canvas.getContext("2d");
	            ctx.drawImage(this,0,0);

	            var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
	            var data = imageData.data;
	            var r,g,b, max_rgb;
	            var light = 0, dark = 0;

	            for(var x = 0, len = data.length; x < len; x+=4) {
	                r = data[x];
	                g = data[x+1];
	                b = data[x+2];

	                max_rgb = Math.max(Math.max(r, g), b);
	                if (max_rgb < 128)
	                    dark++;
	                else
	                    light++;
	            }
	            var dl_diff = ((light - dark) / (this.width*this.height));
	            if (dl_diff + fuzzy < 0)
	                callback(true); /* Dark. */
	            else
	                callback(false);  /* Not dark. */
	        }
	    }


	/// debug code
	    
	var imgs = document.body.getElementsByTagName('img');

	for(var x = 0; x < imgs.length; x++) {
	    imgs[x].onclick = function() {
	        isItDark(this.src,function(darkornot) {
	            console.log("Dark? " + darkornot)
	        });            
	    }
	}
	</script>
  </head>
<body>
<div id='panels'></div>

</body>
</html>